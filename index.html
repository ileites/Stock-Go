<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Conversación de IAs en tiempo real</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #textoEntrada { width: 100%; height: 150px; }
    #chat { margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; }
    .mensaje { margin-bottom: 10px; padding: 5px; border-radius: 5px; }
    .IA-1 { background: #d0e7ff; color: #004080; font-weight: bold; }
    .IA-2 { background: #d0ffd8; color: #006400; font-weight: bold; }
</style>
</head>
<body>

<h2>Conversación de IAs en tiempo real</h2>

<input type="file" id="pdfFile"><br><br>
<textarea id="textoEntrada" placeholder="Escribí el texto o espera a procesar un PDF..."></textarea><br><br>
<button id="procesar">Procesar PDF</button>
<button id="comenzar">Comenzar conversación</button>
<button id="agregarTurno">Agregar turno</button>

<div id="chat"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
let textoFinal = "";
let mensaje1 = "";
let turnoActual = 0;
const chatDiv = document.getElementById('chat');

// Procesar PDF
document.getElementById('procesar').onclick = async () => {
    const file = document.getElementById('pdfFile').files[0];
    if(!file) return alert("Selecciona un PDF");

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let text = "";

    for(let i=1; i<=pdf.numPages; i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(" ") + "\n\n";
    }

    textoFinal = text;
    document.getElementById('textoEntrada').value = textoFinal;
}

// Función para mostrar mensaje palabra por palabra
async function mostrarMensaje(ia, mensaje) {
    const div = document.createElement("div");
    div.className = "mensaje " + ia;
    chatDiv.appendChild(div);

    let texto = "";
    for(const palabra of mensaje.split(" ")) {
        texto += palabra + " ";
        div.textContent = ia + ": " + texto;
        chatDiv.scrollTop = chatDiv.scrollHeight;
        await new Promise(r => setTimeout(r, 80));
    }
}

// Generar un turno
async function generarTurno() {
    try {
        const resp = await fetch("http://localhost:3000/conversacion", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: mensaje1, turnos: 1 })
        });
        const data = await resp.json();

        for(const msg of data.chat){
            await mostrarMensaje(msg.ia, msg.mensaje);

            if(msg.ia === "IA-2"){
                mensaje1 = `Revisa lo que IA-2 dijo y profundiza aún más:\n${msg.mensaje}`;
            }
        }
        turnoActual++;
    } catch(err) {
        console.error("Error en conversación:", err);
        const div = document.createElement("div");
        div.className = "mensaje";
        div.textContent = "Error al conectar con el servidor.";
        chatDiv.appendChild(div);
    }
}

// Comenzar conversación
document.getElementById('comenzar').onclick = async () => {
    textoFinal = document.getElementById('textoEntrada').value.trim();
    if(!textoFinal) return alert("Escribí algo o procesa un PDF primero");

    chatDiv.innerHTML = "Iniciando conversación...";
    turnoActual = 0;
    mensaje1 = `Eres una IA curiosa e investigadora de la verdad. Analiza este texto y propón un análisis detallado:\n\n${textoFinal}`;
    
    await generarTurno();
}

// Agregar turno extra
document.getElementById('agregarTurno').onclick = async () => {
    if(!mensaje1) return alert("Primero iniciá la conversación");
    await generarTurno();
}
</script>

</body>
</html>
